require_dependency 'archived'

module Archived
  class GovernmentResponse < ActiveRecord::Base
    belongs_to :petition, touch: true

    validates :petition, presence: true
    validates :summary, presence: true, length: { maximum: 500 }
    validates :details, length: { maximum: 10000 }, allow_blank: true
    validates :responded_on, presence: true

    after_create do
      petition.touch(:government_response_at) unless petition.government_response_at?
    end

    after_destroy do
      # this will prevent EmailThresholdResponseJob from sending out emails for the deleted response
      petition.set_email_requested_at_for('government_response') 
    end  

    def responded_on
      super || default_responded_on
    end

    private

    def default_responded_on
      if petition && petition.government_response_at
        petition.government_response_at.to_date
      elsif created_at
        created_at.to_date
      end
    end
  end
end
